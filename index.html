<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>QR 출근부 시스템</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }

    h1 {
      color: #333;
    }

    .section {
      background: #fff;
      padding: 20px;
      margin-bottom: 40px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 5px 0;
    }

    #qrCanvas img {
      margin-top: 10px;
    }

    #downloadLink {
      display: none;
      margin-top: 10px;
      padding: 6px 12px;
      background: #28a745;
      color: #fff;
      border-radius: 5px;
      text-decoration: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }

    th {
      background: #eee;
    }

    #reader {
      width: 100%;
      max-width: 400px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <!-- QR 코드 생성기 -->
  <div class="section">
    <h1>📌 직원 QR 코드 생성기</h1>
    <input type="text" id="employeeId" placeholder="직원 이름 또는 ID 입력">
    <button onclick="generateQRCode()">QR 코드 생성</button>
    <div id="qrCanvas"></div>
    <a id="downloadLink" download="qrcode.png">📥 QR 코드 다운로드</a>
  </div>

  <!-- 출근부 시스템 -->
  <div class="section">
    <h1>🕓 직원 출근부 (QR 스캔 인식)</h1>
    <div id="reader"></div>
    <table>
      <thead>
        <tr>
          <th>직원 ID</th>
          <th>출근 시간</th>
          <th>퇴근 시간</th>
        </tr>
      </thead>
      <tbody id="attendanceTable"></tbody>
    </table>
  </div>

  <script>
    const attendanceData = {};

    // QR 코드 생성
    function generateQRCode() {
      const id = document.getElementById("employeeId").value.trim();
      const canvasDiv = document.getElementById("qrCanvas");
      const downloadLink = document.getElementById("downloadLink");

      if (!id) {
        alert("직원 ID를 입력해주세요.");
        return;
      }

      canvasDiv.innerHTML = "";
      QRCode.toDataURL(id, { width: 200, margin: 2 }, function (err, url) {
        if (err) return console.error(err);

        const img = document.createElement("img");
        img.src = url;
        canvasDiv.appendChild(img);

        downloadLink.href = url;
        downloadLink.style.display = "inline-block";
      });
    }

    // 출퇴근 기록 저장 (확인창 포함)
    function recordAttendance(id) {
      const now = new Date().toLocaleTimeString();

      if (!attendanceData[id]) {
        const confirmIn = confirm(`[${id}] 님 출근하시겠습니까?`);
        if (confirmIn) {
          attendanceData[id] = { checkIn: now, checkOut: "" };
          updateTable();
        }
      } else if (!attendanceData[id].checkOut) {
        const confirmOut = confirm(`[${id}] 님 퇴근하시겠습니까?`);
        if (confirmOut) {
          attendanceData[id].checkOut = now;
          updateTable();
        }
      } else {
        alert(`[${id}] 님은 이미 출퇴근을 완료하셨습니다.`);
      }
    }

    // 출근부 테이블 갱신
    function updateTable() {
      const table = document.getElementById("attendanceTable");
      table.innerHTML = "";

      for (const id in attendanceData) {
        const { checkIn, checkOut } = attendanceData[id];
        const row = `<tr>
                      <td>${id}</td>
                      <td>${checkIn}</td>
                      <td>${checkOut || "-"}</td>
                    </tr>`;
        table.innerHTML += row;
      }
    }

    // 카메라 초기화 (후면 카메라 우선)
    const html5QrCode = new Html5Qrcode("reader");

    Html5Qrcode.getCameras().then(cameras => {
      if (cameras && cameras.length) {
        const backCamera = cameras.find(cam =>
          cam.label.toLowerCase().includes("back") ||
          cam.label.toLowerCase().includes("environment")
        ) || cameras[0];

        html5QrCode.start(
          backCamera.id,
          { fps: 10, qrbox: 250 },
          qrCodeMessage => {
            recordAttendance(qrCodeMessage.trim());
          },
          errorMessage => {
            // 무시 가능
          }
        );
      }
    }).catch(err => {
      alert("카메라 접근 실패: " + err);
    });
  </script>

</body>
</html>
