<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>QR ì¶œí‡´ê·¼ ì‹œìŠ¤í…œ</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      padding: 20px;
      text-align: center;
    }
    h1 {
      color: #333;
    }
    video {
      width: 100%;
      max-width: 400px;
      border: 2px solid #aaa;
      border-radius: 10px;
    }
    #qrcodeCanvas img {
      margin-top: 10px;
    }
    input, button {
      padding: 10px;
      margin: 5px;
    }
    table {
      width: 100%;
      max-width: 700px;
      margin: 20px auto;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background: #eee;
    }
  </style>
</head>
<body>

  <h1>âœ… QR ì¶œí‡´ê·¼ ì‹œìŠ¤í…œ</h1>

  <!-- QR ì½”ë“œ ìƒì„±ê¸° -->
  <h2>ğŸ”² ì§ì› QR ì½”ë“œ ìƒì„±ê¸°</h2>
  <input type="text" id="employeeId" placeholder="ì§ì› ì´ë¦„ ë˜ëŠ” ID ì…ë ¥">
  <button onclick="generateQRCode()">QR ì½”ë“œ ìƒì„±</button>
  <button onclick="saveQRListToFile()">ğŸ“¥ QR ëª©ë¡ ì €ì¥</button>
  <input type="file" id="qrFileInput" accept=".json" onchange="loadQRListFromFile(event)">
  <div id="qrcodeCanvas"></div>

  <hr>

  <!-- QR ì¹´ë©”ë¼ ì¸ì‹ -->
  <h2>ğŸ“· QR ì¹´ë©”ë¼ ì¸ì‹ (ì¶œê·¼/í‡´ê·¼)</h2>
  <video id="video" autoplay></video>
  <canvas id="canvas" style="display: none;"></canvas>

  <!-- ì¶œê·¼ë¶€ í…Œì´ë¸” -->
  <h2>ğŸ•“ ì¶œê·¼ë¶€ ê¸°ë¡</h2>
  <table>
    <thead>
      <tr>
        <th>ì´ë¦„</th>
        <th>ì‹œê°„</th>
        <th>ì¶œÂ·í‡´ê·¼</th>
        <th>í™•ì¸</th>
      </tr>
    </thead>
    <tbody id="logTableBody"></tbody>
  </table>

  <button onclick="downloadCSV()">ğŸ“… CSV ë‹¤ìš´ë¡œë“œ</button>

  <script>
    const logs = [];
    const allowedQRs = new Set(JSON.parse(localStorage.getItem("allowedQRs") || "[]"));
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const logTableBody = document.getElementById("logTableBody");

    function generateQRCode() {
      const id = document.getElementById("employeeId").value.trim();
      const container = document.getElementById("qrcodeCanvas");
      if (!id) {
        alert("ì§ì› ì´ë¦„ ë˜ëŠ” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      container.innerHTML = "";
      allowedQRs.add(id);
      localStorage.setItem("allowedQRs", JSON.stringify([...allowedQRs]));
      QRCode.toDataURL(id, { width: 200 }, (err, url) => {
        const img = document.createElement("img");
        img.src = url;
        container.appendChild(img);
      });
    }

    function scanQRCode() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if (code && code.data) {
          const data = code.data.trim();
          if (!allowedQRs.has(data)) {
            alert("ìœ íš¨í•˜ì§€ ì•Šì€ QR ì½”ë“œì…ë‹ˆë‹¤.");
            return;
          }
          processQR(data);
        }
      }
    }

    function processQR(name) {
      const now = new Date();
      const time = now.toLocaleString("ko-KR");
      const date = now.toISOString().split("T")[0];
      const existing = logs.find(log => log.name === name && log.date === date);
      const type = existing && existing.type === "ì¶œê·¼" ? "í‡´ê·¼" : "ì¶œê·¼";

      if (!confirm(`${name}ë‹˜ ${type} ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      const entry = { name, time, type, date };
      logs.push(entry);

      const row = document.createElement("tr");
      row.innerHTML = `<td>${entry.name}</td><td>${entry.time}</td><td>${entry.type}</td><td>âœ”ï¸</td>`;
      logTableBody.appendChild(row);

      saveToGoogleSheets(entry);
    }

    function saveToGoogleSheets(entry) {
      fetch("https://script.google.com/macros/s/AKfycbwGBYXHIIJZh0IiXwfNQl1f9h7PHlXAVS7cnIeaysOkccw1PUaL0qv1n1FZkce-1f3O/exec", {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(entry)
      }).catch(err => console.error("Google ì €ì¥ ì˜¤ë¥˜", err));
    }

    function downloadCSV() {
      let csv = "ì´ë¦„,ì‹œê°„,ì¶œÂ·í‡´ê·¼\n";
      logs.forEach(log => {
        csv += `${log.name},${log.time},${log.type}\n`;
      });
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "ì¶œí‡´ê·¼ê¸°ë¡.csv";
      link.click();
    }

    function saveQRListToFile() {
      const blob = new Blob([JSON.stringify([...allowedQRs])], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "qr_list.json";
      link.click();
    }

    function loadQRListFromFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const loaded = JSON.parse(e.target.result);
          loaded.forEach(id => allowedQRs.add(id));
          localStorage.setItem("allowedQRs", JSON.stringify([...allowedQRs]));
          alert("QR ëª©ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤.");
        } catch (err) {
          alert("QR ëª©ë¡ íŒŒì¼ ì˜¤ë¥˜: " + err.message);
        }
      };
      reader.readAsText(file);
    }

    function startCamera() {
      navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } }
      }).then(stream => {
        video.srcObject = stream;
        setInterval(scanQRCode, 1500);
      }).catch(err => {
        alert("ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: " + err.message);
      });
    }

    startCamera();
  </script>

  <script>
  // Google Apps Scriptì— ì…ë ¥í•  ì„œë²„ ì¸¡ ì½”ë“œ (ì°¸ê³ ìš© ì£¼ì„)
  /*
  function doPost(e) {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = JSON.parse(e.postData.contents);
    sheet.appendRow([data.name, data.time, data.type]);
    return ContentService.createTextOutput("Success");
  }
  */
  </script>

</body>
</html>
