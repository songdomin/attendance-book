<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>QR ì¶œí‡´ê·¼ ì‹œìŠ¤í…œ</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      padding: 20px;
      text-align: center;
    }
    h1 {
      color: #333;
    }
    video {
      width: 100%;
      max-width: 400px;
      border: 2px solid #aaa;
      border-radius: 10px;
    }
    #qrcodeCanvas img {
      margin-top: 10px;
    }
    input, button {
      padding: 10px;
      margin: 5px;
    }
    table {
      width: 100%;
      max-width: 700px;
      margin: 20px auto;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background: #eee;
    }
  </style>
</head>
<body>

  <h1>âœ… QR ì¶œí‡´ê·¼ ì‹œìŠ¤í…œ</h1>

  <!-- QR ì½”ë“œ ìƒì„±ê¸° -->
  <h2>ğŸ”² ì§ì› QR ì½”ë“œ ìƒì„±ê¸°</h2>
  <input type="text" id="employeeId" placeholder="ì§ì› ì´ë¦„ ë˜ëŠ” ID ì…ë ¥">
  <button onclick="generateQRCode()">QR ì½”ë“œ ìƒì„±</button>
  <div id="qrcodeCanvas"></div>

  <hr>

  <!-- QR ì¹´ë©”ë¼ ì¸ì‹ -->
  <h2>ğŸ“· QR ì¹´ë©”ë¼ ì¸ì‹ (ì¶œê·¼/í‡´ê·¼)</h2>
  <video id="video" autoplay></video>
  <canvas id="canvas" style="display: none;"></canvas>

  <!-- ì¶œê·¼ë¶€ í…Œì´ë¸” -->
  <h2>ğŸ•“ ì¶œê·¼ë¶€ ê¸°ë¡</h2>
  <table>
    <thead>
      <tr>
        <th>ì´ë¦„</th>
        <th>ì‹œê°„</th>
        <th>ì¶œÂ·í‡´ê·¼</th>
        <th>í™•ì¸</th>
      </tr>
    </thead>
    <tbody id="logTableBody"></tbody>
  </table>

  <button onclick="downloadCSV()">ğŸ“… CSV ë‹¤ìš´ë¡œë“œ</button>

  <script>
    const logs = [];
    const allowedQRs = new Set();
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const logTableBody = document.getElementById("logTableBody");

    // QR ì½”ë“œ ìƒì„±
    function generateQRCode() {
      const id = document.getElementById("employeeId").value.trim();
      const container = document.getElementById("qrcodeCanvas");
      if (!id) {
        alert("ì§ì› ì´ë¦„ ë˜ëŠ” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      container.innerHTML = "";
      allowedQRs.add(id);
      QRCode.toDataURL(id, { width: 200 }, (err, url) => {
        const img = document.createElement("img");
        img.src = url;
        container.appendChild(img);
      });
    }

    // QR ì¸ì‹
    function scanQRCode() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if (code && code.data) {
          const data = code.data.trim();
          if (!allowedQRs.has(data)) {
            alert("ìœ íš¨í•˜ì§€ ì•Šì€ QR ì½”ë“œì…ë‹ˆë‹¤.");
            return;
          }
          processQR(data);
        }
      }
    }

    // ì¶œê·¼/í‡´ê·¼ ê¸°ë¡ ì²˜ë¦¬
    function processQR(name) {
      const now = new Date();
      const time = now.toLocaleString("ko-KR");
      const date = now.toISOString().split("T")[0];

      const existing = logs.find(log => log.name === name && log.date === date);
      const type = existing && existing.type === "ì¶œê·¼" ? "í‡´ê·¼" : "ì¶œê·¼";

      if (!confirm(`${name}ë‹˜ ${type} ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      const entry = { name, time, type, date };
      logs.push(entry);

      const row = document.createElement("tr");
      row.innerHTML = `<td>${entry.name}</td><td>${entry.time}</td><td>${entry.type}</td><td>âœ”ï¸</td>`;
      logTableBody.appendChild(row);

      saveToGoogleSheets(entry);
    }

    // Google Sheets ì €ì¥
    function saveToGoogleSheets(entry) {
      fetch("https://script.google.com/macros/s/AKfycbwXb6MekhTCTPIG4gVhQYz-tKt3mGu39GhqOqnZDmZCpmIyQAi_mRx6uyts9QDm3GcMzQ/exec", {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(entry)
      }).catch(err => console.error("Google ì €ì¥ ì˜¤ë¥˜", err));
    }

    // CSV ë‹¤ìš´ë¡œë“œ
    function downloadCSV() {
      let csv = "ì´ë¦„,ì‹œê°„,ì¶œÂ·í‡´ê·¼\n";
      logs.forEach(log => {
        csv += `${log.name},${log.time},${log.type}\n`;
      });
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "ì¶œí‡´ê·¼ê¸°ë¡.csv";
      link.click();
    }

    // ì¹´ë©”ë¼ ì‹œì‘
    function startCamera() {
      navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } }
      }).then(stream => {
        video.srcObject = stream;
        setInterval(scanQRCode, 1500);
      }).catch(err => {
        alert("\uce74\uba54\ub77c \uc811\uadfc \uc624\ub958: " + err.message);
      });
    }

    startCamera();
  </script>

</body>
</html>
