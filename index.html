<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>QR ì¶œê·¼ë¶€ ì‹œìŠ¤í…œ</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }

    h1 {
      color: #333;
    }

    .section {
      background: #fff;
      padding: 20px;
      margin-bottom: 40px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 5px 0;
    }

    #qrCanvas img {
      margin-top: 10px;
    }

    #downloadLink {
      display: none;
      margin-top: 10px;
      padding: 6px 12px;
      background: #28a745;
      color: #fff;
      border-radius: 5px;
      text-decoration: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }

    th {
      background: #eee;
    }

    #reader {
      width: 100%;
      max-width: 400px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <!-- QR ì½”ë“œ ìƒì„±ê¸° -->
  <div class="section">
    <h1>ğŸ“Œ ì§ì› QR ì½”ë“œ ìƒì„±ê¸°</h1>
    <input type="text" id="employeeId" placeholder="ì§ì› ì´ë¦„ ë˜ëŠ” ID ì…ë ¥">
    <button onclick="generateQRCode()">QR ì½”ë“œ ìƒì„±</button>
    <div id="qrCanvas"></div>
    <a id="downloadLink" download="qrcode.png">ğŸ“¥ QR ì½”ë“œ ë‹¤ìš´ë¡œë“œ</a>
  </div>

  <!-- ì¶œê·¼ë¶€ ì‹œìŠ¤í…œ -->
  <div class="section">
    <h1>ğŸ•“ ì§ì› ì¶œê·¼ë¶€ (QR ìŠ¤ìº” ì¸ì‹)</h1>
    <div id="reader"></div>
    <table>
      <thead>
        <tr>
          <th>ì§ì› ID</th>
          <th>ì¶œê·¼ ì‹œê°„</th>
          <th>í‡´ê·¼ ì‹œê°„</th>
        </tr>
      </thead>
      <tbody id="attendanceTable"></tbody>
    </table>
  </div>

  <script>
    const attendanceData = {};

    // QR ì½”ë“œ ìƒì„±
    function generateQRCode() {
      const id = document.getElementById("employeeId").value.trim();
      const canvasDiv = document.getElementById("qrCanvas");
      const downloadLink = document.getElementById("downloadLink");

      if (!id) {
        alert("ì§ì› IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      canvasDiv.innerHTML = "";
      QRCode.toDataURL(id, { width: 200, margin: 2 }, function (err, url) {
        if (err) return console.error(err);

        const img = document.createElement("img");
        img.src = url;
        canvasDiv.appendChild(img);

        downloadLink.href = url;
        downloadLink.style.display = "inline-block";
      });
    }

    // ì¶œí‡´ê·¼ ê¸°ë¡ ì €ì¥ (í™•ì¸ì°½ í¬í•¨)
    function recordAttendance(id) {
      const now = new Date().toLocaleTimeString();

      if (!attendanceData[id]) {
        const confirmIn = confirm(`[${id}] ë‹˜ ì¶œê·¼í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
        if (confirmIn) {
          attendanceData[id] = { checkIn: now, checkOut: "" };
          updateTable();
        }
      } else if (!attendanceData[id].checkOut) {
        const confirmOut = confirm(`[${id}] ë‹˜ í‡´ê·¼í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
        if (confirmOut) {
          attendanceData[id].checkOut = now;
          updateTable();
        }
      } else {
        alert(`[${id}] ë‹˜ì€ ì´ë¯¸ ì¶œí‡´ê·¼ì„ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤.`);
      }
    }

    // ì¶œê·¼ë¶€ í…Œì´ë¸” ê°±ì‹ 
    function updateTable() {
      const table = document.getElementById("attendanceTable");
      table.innerHTML = "";

      for (const id in attendanceData) {
        const { checkIn, checkOut } = attendanceData[id];
        const row = `<tr>
                      <td>${id}</td>
                      <td>${checkIn}</td>
                      <td>${checkOut || "-"}</td>
                    </tr>`;
        table.innerHTML += row;
      }
    }

    // ì¹´ë©”ë¼ ì´ˆê¸°í™” (í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ )
    const html5QrCode = new Html5Qrcode("reader");

    Html5Qrcode.getCameras().then(cameras => {
      if (cameras && cameras.length) {
        const backCamera = cameras.find(cam =>
          cam.label.toLowerCase().includes("back") ||
          cam.label.toLowerCase().includes("environment")
        ) || cameras[0];

        html5QrCode.start(
          backCamera.id,
          { fps: 10, qrbox: 250 },
          qrCodeMessage => {
            recordAttendance(qrCodeMessage.trim());
          },
          errorMessage => {
            // ë¬´ì‹œ ê°€ëŠ¥
          }
        );
      }
    }).catch(err => {
      alert("ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + err);
    });
  </script>

</body>
</html>
